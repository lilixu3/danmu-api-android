name: Manual Build APK + Publish Release (pull danmu_api)

on:
  workflow_dispatch:
    inputs:
      danmu_repo:
        description: "danmu_api 仓库（owner/repo）"
        required: true
        default: "lilixu3/danmu_api"
      danmu_ref:
        description: "danmu_api 分支/Tag/提交（ref）"
        required: true
        default: "main"
      app_version_name:
        description: "APP 版本号 versionName（例如 0.2.1）"
        required: true
        default: "0.1.0"
      app_version_code:
        description: "APP 版本号 versionCode（整数，例如 10）"
        required: true
        default: "1"
      nodejs_mobile_tag:
        description: "nodejs-mobile core library tag（例如 v18.20.4）"
        required: true
        default: "v18.20.4"
      build_variant:
        description: "构建类型：release 或 debug"
        required: true
        default: "release"

permissions:
  contents: write

env:
  DANMU_PATH: app/src/main/assets/nodejs-project/danmu_api
  ANDROID_API: "34"
  BUILD_TOOLS: "34.0.0"
  NDK_VERSION: "26.1.10909125"
  CMAKE_VERSION: "3.22.1"

jobs:
  build_and_release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout app repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout danmu_api into assets
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.danmu_repo }}
          ref: ${{ inputs.danmu_ref }}
          path: ${{ env.DANMU_PATH }}

      - name: Setup Node.js (build-time)
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install node deps (nodejs-project)
        working-directory: app/src/main/assets/nodejs-project
        run: |
          if [ -f package.json ]; then
            npm install --omit=dev
          fi

      - name: Install node deps (danmu_api)
        working-directory: app/src/main/assets/nodejs-project/danmu_api
        run: |
          if [ -f package.json ]; then
            npm install --omit=dev
          fi

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android components (platform/build-tools/ndk/cmake)
        run: |
          sdkmanager "platforms;android-${ANDROID_API}" \
                     "build-tools;${BUILD_TOOLS}" \
                     "platform-tools" \
                     "ndk;${NDK_VERSION}" \
                     "cmake;${CMAKE_VERSION}"

      # 可选：如果你想让 release APK 使用“固定签名”，就在 Secrets 里配置这些（见下方）
      - name: Prepare keystore (optional)
        if: ${{ secrets.ANDROID_KEYSTORE_B64 != '' }}
        run: |
          set -e
          echo "${{ secrets.ANDROID_KEYSTORE_B64 }}" | base64 -d > /tmp/ci.keystore
          echo "ANDROID_KEYSTORE_PATH=/tmp/ci.keystore" >> $GITHUB_ENV
          echo "ANDROID_KEYSTORE_PASSWORD=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          echo "ANDROID_KEY_ALIAS=${{ secrets.ANDROID_KEY_ALIAS }}" >> $GITHUB_ENV
          echo "ANDROID_KEY_PASSWORD=${{ secrets.ANDROID_KEY_PASSWORD }}" >> $GITHUB_ENV

      - name: Download nodejs-mobile Android release zip and place into app/libnode
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e
          rm -rf /tmp/nodejs-mobile
          mkdir -p /tmp/nodejs-mobile
          cd /tmp/nodejs-mobile

          gh release download "${{ inputs.nodejs_mobile_tag }}" \
            -R nodejs-mobile/nodejs-mobile \
            -p "*android*.zip"

          unzip -q *.zip -d extracted

          rm -rf "$GITHUB_WORKSPACE/app/libnode/include" "$GITHUB_WORKSPACE/app/libnode/bin"
          mkdir -p "$GITHUB_WORKSPACE/app/libnode"

          cp -R extracted/include "$GITHUB_WORKSPACE/app/libnode/include"
          cp -R extracted/bin     "$GITHUB_WORKSPACE/app/libnode/bin"

      - name: Grant execute permission to gradlew
        run: chmod +x ./gradlew

      - name: Build APK
        env:
          # 你的 app/build.gradle 已支持 APP_VERSION_NAME/APP_VERSION_CODE 覆盖
          APP_VERSION_NAME: ${{ inputs.app_version_name }}
          APP_VERSION_CODE: ${{ inputs.app_version_code }}
        run: |
          set -e
          if [ "${{ inputs.build_variant }}" = "debug" ]; then
            ./gradlew :app:assembleDebug \
              -PAPP_VERSION_NAME="${{ inputs.app_version_name }}" \
              -PAPP_VERSION_CODE="${{ inputs.app_version_code }}" \
              --stacktrace
          else
            ./gradlew :app:assembleRelease \
              -PAPP_VERSION_NAME="${{ inputs.app_version_name }}" \
              -PAPP_VERSION_CODE="${{ inputs.app_version_code }}" \
              --stacktrace
          fi

      - name: Collect APK
        id: apk
        run: |
          set -e
          if [ "${{ inputs.build_variant }}" = "debug" ]; then
            APK_PATH=$(ls -1 app/build/outputs/apk/debug/*.apk | head -n 1)
          else
            APK_PATH=$(ls -1 app/build/outputs/apk/release/*.apk | head -n 1)
          fi
          echo "apk_path=$APK_PATH" >> "$GITHUB_OUTPUT"
          echo "APK: $APK_PATH"

      - name: Compute release tag/name
        id: rel
        run: |
          set -e
          TAG="v${{ inputs.app_version_name }}"
          NAME="DanmuApiApp ${{ inputs.app_version_name }} (${{
            inputs.build_variant
          }})"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "name=$NAME" >> "$GITHUB_OUTPUT"

      - name: Publish GitHub Release (upload APK)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.rel.outputs.tag }}
          name: ${{ steps.rel.outputs.name }}
          target_commitish: ${{ github.sha }}
          generate_release_notes: true
          files: |
            ${{ steps.apk.outputs.apk_path }}
