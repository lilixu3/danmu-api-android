name: Build APK (DanmuTermuxLauncher)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Unzip project and locate root
        run: |
          rm -rf project
          mkdir -p project
          unzip -q DanmuTermuxLauncher.zip -d project

          ROOT="$(find project -maxdepth 10 -type f \( -name 'settings.gradle' -o -name 'settings.gradle.kts' \) -print -quit | xargs -r dirname)"
          if [ -z "$ROOT" ]; then
            echo "❌ 没找到 settings.gradle / settings.gradle.kts"
            exit 1
          fi

          echo "PROJECT_ROOT=$ROOT" >> "$GITHUB_ENV"
          echo "Project root: $ROOT"

      - name: Accept licenses & install SDK packages (compileSdk 36)
        run: |
          yes | sdkmanager --licenses >/dev/null
          sdkmanager "platforms;android-36" "build-tools;36.0.0" "platform-tools"

      - name: Patch Kotlin jvmTarget (kotlinOptions -> compilerOptions)
        run: |
          FILE="$PROJECT_ROOT/app/build.gradle.kts"
          if [ ! -f "$FILE" ]; then
            echo "❌ 找不到 $FILE"
            exit 1
          fi

          python3 - <<'PY'
          import os, re
          from pathlib import Path

          file_path = Path(os.environ["PROJECT_ROOT"]) / "app" / "build.gradle.kts"
          t = file_path.read_text(encoding="utf-8")

          # 移除旧 DSL：kotlinOptions { jvmTarget = "17" }
          t2 = re.sub(
              r"\n\s*kotlinOptions\s*\{\s*\n\s*jvmTarget\s*=\s*\"17\"\s*\n\s*\}\s*\n",
              "\n",
              t,
              count=1
          )

          # 插入新 DSL：kotlin { compilerOptions { jvmTarget.set(...) } }
          if "compilerOptions" not in t2:
            marker = re.search(r"\n\s*dependencies\s*\{", t2)
            if not marker:
              raise SystemExit("❌ 没找到 dependencies { 位置，无法插入 compilerOptions")
            insert = (
              "\n\nkotlin {\n"
              "    compilerOptions {\n"
              "        jvmTarget.set(org.jetbrains.kotlin.gradle.dsl.JvmTarget.JVM_17)\n"
              "    }\n"
              "}\n"
            )
            t2 = t2[:marker.start()] + insert + t2[marker.start():]

          file_path.write_text(t2, encoding="utf-8")
          print("✅ patched:", file_path)
          PY

          echo "=== patched build.gradle.kts (first 140 lines) ==="
          sed -n '1,140p' "$FILE"

      - name: Build Debug APK
        env:
          GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx2g -Dkotlin.daemon.jvm.options=-Xmx1g"
        run: |
          cd "$PROJECT_ROOT"
          chmod +x ./gradlew
          ./gradlew --no-daemon :app:assembleDebug

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: ${{ env.PROJECT_ROOT }}/app/build/outputs/apk/debug/*.apk
