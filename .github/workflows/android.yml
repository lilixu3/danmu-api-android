name: Manual Build APK + Publish Release (pull danmu_api)

on:
  workflow_dispatch:
    inputs:
      danmu_repo:
        description: "danmu_api 仓库（owner/repo）"
        required: true
        default: "lilixu3/danmu_api"
      danmu_ref:
        description: "danmu_api 分支/Tag/提交（ref）"
        required: true
        default: "main"
      app_version_name:
        description: "APP versionName（例如 0.2.1）"
        required: true
        default: "0.1.0"
      app_version_code:
        description: "APP versionCode（整数，例如 21）"
        required: true
        default: "1"
      release_tag:
        description: "发行版 Tag（留空则用 v{versionName}）"
        required: false
        default: ""
      nodejs_mobile_tag:
        description: "nodejs-mobile tag（例如 v18.20.4）"
        required: true
        default: "v18.20.4"
      build_variant:
        description: "release 或 debug"
        required: true
        default: "release"

permissions:
  contents: write

env:
  DANMU_PATH: app/src/main/assets/nodejs-project/danmu_api
  ANDROID_API: "34"
  BUILD_TOOLS: "34.0.0"
  NDK_VERSION: "26.1.10909125"
  CMAKE_VERSION: "3.22.1"

jobs:
  build_and_release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout app repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Checkout danmu_api into assets
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.danmu_repo }}
          ref: ${{ inputs.danmu_ref }}
          path: ${{ env.DANMU_PATH }}
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install node deps (nodejs-project)
        working-directory: app/src/main/assets/nodejs-project
        run: |
          set -euo pipefail
          if [ -f package.json ]; then
            if [ -f package-lock.json ]; then
              npm ci --omit=dev
            else
              npm install --omit=dev
            fi
          fi

      - name: Install node deps (danmu_api)
        working-directory: app/src/main/assets/nodejs-project/danmu_api
        run: |
          set -euo pipefail
          if [ -f package.json ]; then
            if [ -f package-lock.json ]; then
              npm ci --omit=dev
            else
              npm install --omit=dev
            fi
          fi

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android components (platform/build-tools/ndk/cmake)
        run: |
          set -euo pipefail
          sdkmanager "platforms;android-${ANDROID_API}" \
                     "build-tools;${BUILD_TOOLS}" \
                     "platform-tools" \
                     "ndk;${NDK_VERSION}" \
                     "cmake;${CMAKE_VERSION}"

      - name: Download nodejs-mobile Android zip and place into app/libnode (robust)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          rm -rf /tmp/nodejs-mobile
          mkdir -p /tmp/nodejs-mobile
          cd /tmp/nodejs-mobile

          gh release download "${{ inputs.nodejs_mobile_tag }}" \
            -R nodejs-mobile/nodejs-mobile \
            -p "*android*.zip"

          ls -la
          unzip -q *.zip -d extracted

          # 1) headers: 找到 include/node/node.h 所在
          NODE_H="$(find extracted -type f -path "*/include/node/node.h" | head -n 1 || true)"
          if [ -z "$NODE_H" ]; then
            echo "❌ 没找到 include/node/node.h，说明 zip 结构与预期不同。"
            echo "已解压目录概览："
            find extracted -maxdepth 4 -type d | sed -n '1,120p'
            exit 1
          fi
          INCLUDE_DIR="$(dirname "$(dirname "$NODE_H")")"  # .../include

          # 2) libs: 为每个 ABI 定位 libnode.so，然后拷到 app/libnode/bin/<abi>/libnode.so
          rm -rf "$GITHUB_WORKSPACE/app/libnode"
          mkdir -p "$GITHUB_WORKSPACE/app/libnode/include" "$GITHUB_WORKSPACE/app/libnode/bin"

          cp -R "$INCLUDE_DIR" "$GITHUB_WORKSPACE/app/libnode/include"

          for ABI in armeabi-v7a arm64-v8a x86 x86_64; do
            LIB="$(find extracted -type f -path "*/${ABI}/libnode.so" | head -n 1 || true)"
            if [ -n "$LIB" ]; then
              mkdir -p "$GITHUB_WORKSPACE/app/libnode/bin/${ABI}"
              cp -f "$LIB" "$GITHUB_WORKSPACE/app/libnode/bin/${ABI}/libnode.so"
              echo "✅ libnode.so for ${ABI}: $LIB"
            else
              echo "⚠️ 没找到 ${ABI}/libnode.so（如果你没启用该 ABI 可忽略）"
            fi
          done

          echo "==== libnode tree ===="
          find "$GITHUB_WORKSPACE/app/libnode" -maxdepth 4 -type f | sed -n '1,200p'

          # 最关键：arm64-v8a 必须存在（你日志里就是在 arm64-v8a 上失败）
          test -f "$GITHUB_WORKSPACE/app/libnode/bin/arm64-v8a/libnode.so" || {
            echo "❌ 缺少 app/libnode/bin/arm64-v8a/libnode.so，ninja 必炸。"
            exit 1
          }

      - name: Prepare keystore (optional)
        env:
          ANDROID_KEYSTORE_B64: ${{ secrets.ANDROID_KEYSTORE_B64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          set -euo pipefail
          if [ -z "${ANDROID_KEYSTORE_B64}" ]; then
            echo "No keystore secrets provided, skip signing setup."
            exit 0
          fi
          echo "${ANDROID_KEYSTORE_B64}" | base64 -d > /tmp/ci.keystore
          echo "ANDROID_KEYSTORE_PATH=/tmp/ci.keystore" >> $GITHUB_ENV
          echo "ANDROID_KEYSTORE_PASSWORD=${ANDROID_KEYSTORE_PASSWORD}" >> $GITHUB_ENV
          echo "ANDROID_KEY_ALIAS=${ANDROID_KEY_ALIAS}" >> $GITHUB_ENV
          echo "ANDROID_KEY_PASSWORD=${ANDROID_KEY_PASSWORD}" >> $GITHUB_ENV
          echo "Keystore prepared."

      - name: Grant execute permission to gradlew
        run: chmod +x ./gradlew

      - name: Clean native build cache (.cxx)
        run: |
          set -euo pipefail
          rm -rf app/.cxx || true

      - name: Build APK (verbose)
        run: |
          set -euo pipefail
          if [ "${{ inputs.build_variant }}" = "debug" ]; then
            ./gradlew :app:assembleDebug \
              -PAPP_VERSION_NAME="${{ inputs.app_version_name }}" \
              -PAPP_VERSION_CODE="${{ inputs.app_version_code }}" \
              -Pandroid.native.buildOutput=verbose \
              --stacktrace --info
          else
            ./gradlew :app:assembleRelease \
              -PAPP_VERSION_NAME="${{ inputs.app_version_name }}" \
              -PAPP_VERSION_CODE="${{ inputs.app_version_code }}" \
              -Pandroid.native.buildOutput=verbose \
              --stacktrace --info
          fi

      - name: Upload native logs if failed
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: native-build-logs
          path: |
            app/.cxx/**/*
            app/build/reports/**/*
            app/CMakeLists.txt

      - name: Collect APK
        id: apk
        run: |
          set -euo pipefail
          if [ "${{ inputs.build_variant }}" = "debug" ]; then
            APK_PATH="$(ls -1 app/build/outputs/apk/debug/*.apk | head -n 1)"
          else
            APK_PATH="$(ls -1 app/build/outputs/apk/release/*.apk | head -n 1)"
          fi
          echo "apk_path=$APK_PATH" >> "$GITHUB_OUTPUT"
          echo "APK: $APK_PATH"

      - name: Compute release tag/name/body
        id: rel
        run: |
          set -euo pipefail
          if [ -n "${{ inputs.release_tag }}" ]; then
            TAG="${{ inputs.release_tag }}"
          else
            TAG="v${{ inputs.app_version_name }}"
          fi

          NAME="DanmuApiApp ${{ inputs.app_version_name }} (${{ inputs.build_variant }})"
          BODY=$'danmu_api: '${{ inputs.danmu_repo }}$'\nref: '${{ inputs.danmu_ref }}$'\nversionName: '${{ inputs.app_version_name }}$'\nversionCode: '${{ inputs.app_version_code }}

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "name=$NAME" >> "$GITHUB_OUTPUT"
          echo "body<<EOF" >> "$GITHUB_OUTPUT"
          echo "$BODY" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Publish GitHub Release (upload APK)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.rel.outputs.tag }}
          name: ${{ steps.rel.outputs.name }}
          body: ${{ steps.rel.outputs.body }}
          generate_release_notes: true
          files: |
            ${{ steps.apk.outputs.apk_path }}
